{% extends "_layout.twig" %}

{% block content %}
{% set fields = craft.app.fields %}
{% set servingsField = fields.getFieldByHandle('servings') %}
{% set caloriesField = fields.getFieldByHandle('calories') %}
{% set tagsField = fields.getFieldByHandle('recipeTags') %}
{% set tagGroup = craft.app.tags.getTagGroupByHandle('recipeTags') %}
{% set tags = (tagGroup and tagsField) ? entry.recipeTags.all() : [] %}

<article class="recipe-single">
    <header class="recipe-header">
        <p class="eyebrow">Featured Recipe</p>
        <h1>{{ entry.title }}</h1>
        {% if entry.description %}
            <p class="lede">{{ entry.description }}</p>
        {% endif %}
    </header>

    <div class="entry-actions">
        <button class="favorite-toggle" type="button" data-favorite-button data-recipe-slug="{{ entry.slug }}">Add to favorites</button>
        {% if craft.app.user.isGuest %}
            <a class="btn-secondary" href="{{ url('login') }}">Log in</a>
            <a class="btn-primary" href="{{ url('register') }}">Create account</a>
            <span class="muted">Favorites are saved in your browser. Create an account to sync them later.</span>
        {% else %}
            <span class="muted">Favorites sync with your account.</span>
        {% endif %}
    </div>

    {% set image = entry.recipeImage.one() %}
    {% if image %}
        <figure class="recipe-hero">
            <img src="{{ image.url }}" alt="{{ entry.title }}">
        </figure>
    {% endif %}

    <section class="recipe-meta">
        {% if entry.cookTime %}
            <div>
                <span>Cook Time</span>
                <strong>{{ entry.cookTime }} min</strong>
            </div>
        {% endif %}
        {% if servingsField and entry.servings %}
            <div>
                <span>Servings</span>
                <strong>{{ entry.servings }}</strong>
            </div>
        {% endif %}
        {% if caloriesField and entry.calories %}
            <div>
                <span>Calories</span>
                <strong>{{ entry.calories }}</strong>
            </div>
        {% endif %}
        {% if entry.prepTime %}
            <div>
                <span>Prep Time</span>
                <strong>{{ entry.prepTime }} min</strong>
            </div>
        {% endif %}
        {% if entry.difficulty %}
            {% set difficultyHandle = entry.difficulty|lower %}
            <div>
                <span>Difficulty</span>
                <strong class="difficulty-pill difficulty-{{ difficultyHandle }}">{{ entry.difficulty }}</strong>
            </div>
        {% endif %}
        {% set mealValues = entry.mealCategory ?? [] %}
        {% if mealValues is iterable == false %}
            {% set mealValues = mealValues ? [mealValues] : [] %}
        {% endif %}
        {% if mealValues|length %}
            <div>
                <span>Meal</span>
                <strong>{{ mealValues|map(v => v|title)|join(', ') }}</strong>
            </div>
        {% endif %}
    </section>

    <section class="recipe-panel">
        <h2>Ingredients</h2>
        <div class="panel-body">
            {{ entry.ingredients|nl2br }}
        </div>
    </section>

    <section class="recipe-panel">
        <h2>Steps</h2>
        <div class="panel-body">
            {{ entry.steps|nl2br }}
        </div>
    </section>

    {% if entry.chefNotes %}
        <section class="recipe-panel">
            <h2>Chef notes</h2>
            <div class="notes-panel">
                {{ entry.chefNotes|nl2br }}
            </div>
        </section>
    {% endif %}

    {% if entry.nutritionFacts %}
        <section class="recipe-panel">
            <h2>Nutrition</h2>
            <div class="panel-body">
                {{ entry.nutritionFacts|nl2br }}
            </div>
        </section>
    {% endif %}

    {% if entry.recipeHighlights|length %}
        <section class="recipe-panel">
            <h2>Highlights</h2>
            <div class="recipe-card__badges">
                {% for highlight in entry.recipeHighlights %}
                    <span class="pill-badge">{{ highlight }}</span>
                {% endfor %}
            </div>
        </section>
    {% endif %}

    {% if entry.videoUrl %}
        <section class="recipe-panel">
            <h2>Watch the walkthrough</h2>
            <div class="video-embed">
                <iframe src="{{ entry.videoUrl }}" allowfullscreen></iframe>
            </div>
        </section>
    {% endif %}

    {% if entry.author %}
        <section class="recipe-panel">
            <h2>About the author</h2>
            <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
                {% if entry.author.photoUrl %}
                    <img src="{{ entry.author.photoUrl }}" alt="{{ entry.author.friendlyName ?: entry.author.username }}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">
                {% endif %}
                <div>
                    <p style="margin:0;font-weight:600;">{{ entry.author.friendlyName ?: entry.author.username }}</p>
                    <p class="muted" style="margin:0.15rem 0 0;">{{ entry.author.bio ?? 'Update author bio in the control panel to feature it here.' }}</p>
                </div>
            </div>
        </section>
    {% endif %}

    {% if tags|length %}
        <section class="recipe-panel">
            <h2>Tags</h2>
            <div class="tags-cloud">
                {% for tag in tags %}
                    <a href="{{ url('recipes', { tag: tag.slug }) }}">{{ tag.title }}</a>
                {% endfor %}
            </div>
        </section>
    {% endif %}

    <div class="recipe-share">
        <a href="https://www.pinterest.com/pin/create/button/?url={{ entry.url|url_encode }}&description={{ entry.title|url_encode }}" target="_blank" rel="noopener">Share on Pinterest</a>
        <a href="https://www.facebook.com/sharer/sharer.php?u={{ entry.url|url_encode }}" target="_blank" rel="noopener">Share on Facebook</a>
        <a href="https://twitter.com/intent/tweet?url={{ entry.url|url_encode }}&text={{ entry.title|url_encode }}" target="_blank" rel="noopener">Share on X</a>
    </div>

    {% set relatedQuery = craft.entries.section('recipes').id('not ' ~ entry.id).limit(3) %}
    {% if tags|length %}
        {% set relatedQuery = relatedQuery.relatedTo(tags) %}
    {% elseif entry.difficulty %}
        {% set relatedQuery = relatedQuery.difficulty(entry.difficulty) %}
    {% endif %}
    {% set relatedRecipes = relatedQuery.all() %}
    {% if relatedRecipes|length %}
        <section class="recipe-panel">
            <h2>Related recipes</h2>
            <div class="recipes-grid" style="margin-top:1rem;">
                {% for related in relatedRecipes %}
                    {% include "recipes/_card" with { recipe: related } %}
                {% endfor %}
            </div>
        </section>
    {% endif %}
</article>
{% endblock %}
